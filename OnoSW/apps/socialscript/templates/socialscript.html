{% extends "app.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="static/socialscript.css" />

{% endblock %}

{% block page_content %}
<div class="actionbar">
	<div class="filebox">
		<span data-bind="text: fileName" class="filename"></span> <span data-bind="visible: fileIsModified" class="fa fa-asterisk"></span><br>
		<span class="fa" data-bind="css: { 'fa-lock': fileLocked(), 'fa-pencil': !fileLocked() }" style="font-size: 0.75rem;"></span> <span class="status" data-bind="text: fileLocked() ? 'Locked' : 'Editing' "></span>
	</div>
	<div class="spacer"></div>
	<a href="#"  id="btnSave" class="action" data-bind="click: saveFile">
		<span class="fa fa-save"></span><br/>
		<span class="text">Save</span>
	</a>
	<a href="#"  id="btnFiles" class="action">
		<span class="fa fa-folder"></span><br/>
		<span class="text">All files</span>
	</a>
	<a href="#"  id="btnNew" class="action">
		<span class="fa fa-file"></span><br/>
		<span class="text">New</span>
	</a>
	<div class="spacer"></div>
	<a href="#" id="btnLock" class="action" data-bind="click: toggleLocked">
		<span class="fa" data-bind="css: { 'fa-lock': fileLocked(), 'fa-unlock': !fileLocked() }"></span><br/>
		<span class="text" data-bind="text: fileLocked() ? 'Locked' : 'Unlocked' "></span>
	</a>
	<a href="#" id="btnAdd" class="action" data-bind="visible: !fileLocked(), click: addLine">
		<span class="fa fa-plus"></span><br/>
		<span class="text">Add Line</span>
	</a>
</div>

<div data-alert class="alert-box alert">
	<span class="fa fa-exclamation-triangle"></span> Hello there! This app is a work-in-progress preview, expect things to be buggy, broken and completely non-functional.
	<a href="#" class="close">&times;</a>
</div>

<div id="voicelines" data-bind="sortable: { data: voiceLines, options: {handle: '.gripper', axis: 'y', opacity: 0.75} }">
	<div class="voiceline" data-bind="css: {locked: $root.fileLocked(), unlocked: !$root.fileLocked()}">
		<div class="gripper"></div>
		<div class="avatar">
				<div data-bind="avatar: avatar, click: pickEmotion"></div>
		</div>
		<div class="content">
			<span class="bubble" data-bind="html: contentPreview"></span>
		</div>
		<form>
			<select data-bind="visible: output() != 'tts', options: $root.sounds, value: wav">
			<input type="text" placeholder="Enter text to be spoken..." data-bind="value: tts, visible: output() == 'tts' "></input>
			<div class="leftcontrols">
				<div class="switch round tts-switch">
					<input type="checkbox" data-bind="outputswitch: output, attr: {id: switchID} ">
					<label data-bind="attr: {for: switchID}"></label>
					<span class="switch-tts fa fa-comment"></span>
					<span class="switch-wav fa fa-music"></span>
				</div>
			</div>
			<div class="rightcontrols">
				<a href="#" class="button round alert" data-bind="click: $root.removeLine"><span class="fa fa-trash"></span></a>
				<a href="#" class="button round success"><span class="fa fa-play" style="margin-right: 0.5rem;"></span> test</a>
			</div>
		</form>
		<div class="playbutton" data-bind="css: {active: isPlaying, used: hasPlayed}">
			<div class="bg"></div>
			<a href="#" class="button" data-bind="click: pressPlay">
				<span class="fa fa-fw fa-play" style="font-size: 1.5rem"></span>
			</a>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="static/jquery-ui-sortable/jquery-ui.js"></script>
<script src="static/knockout-sortable.min.js"></script>
<script>
var emotions_data = {{ emotions|tojson|safe }};
var sounds_data = {{ sounds|tojson|safe }};
</script>
<script>
$(document).ready(function(){
	$("#btnShutdown").click(function(){
		$("#ShutdownModal .content").load("/shutdown");
	});

	ko.bindingHandlers.avatar = {
		update: function(element, valueAccessor, allBindings) {
			var value = valueAccessor();
			var valueUnwrapped = ko.unwrap(value);
			$(element).css("background", "url('static/avatars/" + valueUnwrapped + "')")
		}
	};

	ko.bindingHandlers.outputswitch = {
		init: function(element, valueAccessor){
			$(element).change(function(){
				var value = valueAccessor();
				if( $(element).prop("checked") ){
					value("wav");
				}else{
					value("tts");
				}
			});
		},
		update: function(element, valueAccessor, allBindings) {
			var value = valueAccessor();
			var valueUnwrapped = ko.unwrap(value);
			$(element).prop("checked", valueUnwrapped == "tts" ? false : true);
		}
	};

	var switchID = 0; // Variable to generate unique IDs for toggle switches

	// Here's my data model
	var VoiceLine = function(emotion, output, tts, wav){
		var self = this;

		self.emotion = ko.observable(emotion || emotions_data[0]);

		self.output = ko.observable(output || "tts");
		self.tts = ko.observable(tts || "");
		self.wav = ko.observable(wav || sounds_data[0]);

		self.isPlaying = ko.observable(false);
		self.hasPlayed = ko.observable(false);

		self.switchID = "output-switch-" + switchID++;

		self.contentPreview = ko.pureComputed(function(){
			if(self.output() == "tts"){
				// Generate tts preview html
				return "<span class='fa fa-comment'></span> " + self.tts();
			}else{
				// Generate wav preview html
				return "<span class='fa fa-music'></span> " + self.wav();
			}
		});

		self.avatar = ko.pureComputed(function(){
			return self.emotion().image;
		});

		self.toggleOutput = function(){
			if(this.output() == "tts"){
				this.output("wav");
			}else{
				this.output("tts");
			}
		};

		self.pressPlay = function(){
			if(self.isPlaying()){
				self.isPlaying(false);
				self.hasPlayed(true);
			}else{
					self.isPlaying(true)
			}
		};

		self.pickEmotion = function(){
			if(model.fileLocked()){
				return;
			}

			model.selectedVoiceLine(self);
			$("#PickEmotionModal").foundation("reveal", "open");
		};
	}

	var SocialScriptModel = function(){
		var self = this;

		self.fileLocked = ko.observable(false);
		self.fileIsModified = ko.observable(false);
		self.fileName = ko.observable("Untitled");

		self.sounds = sounds_data;
		self.emotions = emotions_data;

		self.selectedVoiceLine = ko.observable();

		self.voiceLines = ko.observableArray([
			new VoiceLine(self.emotions[0], "tts", "Hello", ""),
			new VoiceLine(self.emotions[1], "wav", "",      "Oooh.wav"),
			new VoiceLine(self.emotions[2], "tts", "Ouch!", "")
		]);


		self.toggleLocked = function(){
			self.fileLocked( !self.fileLocked() );
		};

		self.addLine = function(){
			self.voiceLines.push( new VoiceLine(self.emotions[0], "tts", "", "") );
		};

		self.removeLine = function(line){
			self.voiceLines.remove(line);
		};

		self.saveFile = function(){
			var file_data = {voice_lines: []};

			$.each(self.voiceLines(), function(idx, item){
				var line = {};
				line.emotion = item.emotion().name;
				line.output = {};

				if(item.output() == "tts"){
					line.output.type = "tts";
					line.output.data = item.tts();
				}else if(item.output() == "wav"){
					line.output.type = "wav";
					line.output.data = item.wav();
				}else{
					line.output.type = "tts";
					line.output.data = "";
				}

				file_data.voice_lines.push(line);
			});

			//console.log(file_data);
			var json_data = ko.toJSON(file_data, null, 2);
			alert(json_data);
		};

		self.changeEmotion = function(emotion){
			self.selectedVoiceLine().emotion(emotion);
			$("#PickEmotionModal").foundation("reveal", "close");
		};
	};
	// This makes Knockout get to work
	var model = new SocialScriptModel();
	ko.applyBindings(model);
});
</script>
{% endblock %}

{% block modals %}
{{ super() }}
<div id="PickEmotionModal" class="reveal-modal tiny" data-reveal>
	<div class="content">
		<ul class="small-block-grid-4" data-bind="foreach: emotions">
			<li>
				<div class="avatar" data-bind="click: $root.changeEmotion"><div data-bind="avatar: image"></div></div>
				<div class="avatarcaption" data-bind="text: name"></div>
			</li>
		</ul>
	</div>
</div>
{% endblock %}
