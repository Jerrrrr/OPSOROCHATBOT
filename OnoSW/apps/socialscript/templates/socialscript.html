{% extends "app.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="static/socialscript.css" />

{% endblock %}

{% block page_content %}
<div class="actionbar">
	<div class="filebox">
		<span data-bind="text: fileName" class="filename"></span> <span data-bind="visible: fileIsModified" class="fa fa-asterisk"></span><br>
		<span class="fa" data-bind="css: { 'fa-lock': fileLocked(), 'fa-pencil': !fileLocked() }" style="font-size: 0.75rem;"></span> <span class="status" data-bind="text: fileLocked() ? 'Locked' : 'Editing' "></span>
	</div>
	<div class="spacer"></div>
	<a href="#"  id="btnSave" class="action" data-bind="click: askSaveFile">
		<span class="fa fa-save"></span><br/>
		<span class="text">Save</span>
	</a>
	<a href="#"  id="btnFiles" class="action" data-bind="click: showFiles">
		<span class="fa fa-folder"></span><br/>
		<span class="text">All files</span>
	</a>
	<a href="#"  id="btnNew" class="action" data-bind="click: newFile">
		<span class="fa fa-file"></span><br/>
		<span class="text">New</span>
	</a>
	<div class="spacer"></div>
	<a href="#" id="btnLock" class="action" data-bind="click: toggleLocked">
		<span class="fa" data-bind="css: { 'fa-lock': fileLocked(), 'fa-unlock': !fileLocked() }"></span><br/>
		<span class="text" data-bind="text: fileLocked() ? 'Locked' : 'Unlocked' "></span>
	</a>
	<a href="#" id="btnAdd" class="action" data-bind="visible: !fileLocked(), click: addLine">
		<span class="fa fa-plus"></span><br/>
		<span class="text">Add Line</span>
	</a>
</div>

<div data-alert class="alert-box alert">
	<span class="fa fa-exclamation-triangle"></span> Hello there! This app is a work-in-progress preview, expect things to be buggy, broken and completely non-functional.
	<a href="#" class="close">&times;</a>
</div>

<div id="voicelines" data-bind="sortable: { data: voiceLines, options: {handle: '.gripper', axis: 'y', opacity: 0.75} }">
	<div class="voiceline" data-bind="css: {locked: $root.fileLocked(), unlocked: !$root.fileLocked()}">
		<div class="gripper"></div>
		<div class="avatar">
				<div data-bind="avatar: avatar, click: pickEmotion"></div>
		</div>
		<div class="content">
			<span class="bubble" data-bind="html: contentPreview"></span>
		</div>
		<form>
			<select data-bind="visible: output() != 'tts', options: $root.sounds, value: wav">
			<input type="text" placeholder="Enter text to be spoken..." data-bind="value: tts, visible: output() == 'tts' "></input>
			<div class="leftcontrols">
				<div class="switch round tts-switch">
					<input type="checkbox" data-bind="outputswitch: output, attr: {id: switchID} ">
					<label data-bind="attr: {for: switchID}"></label>
					<span class="switch-tts fa fa-comment"></span>
					<span class="switch-wav fa fa-music"></span>
				</div>
			</div>
			<div class="rightcontrols">
				<a href="#" class="button round alert" data-bind="click: $root.removeLine"><span class="fa fa-trash"></span></a>
				<a href="#" class="button round success" data-bind="click: pressPlay"><span class="fa fa-play" style="margin-right: 0.5rem;"></span> test</a>
			</div>
		</form>
		<div class="playbutton" data-bind="css: {active: isPlaying, used: hasPlayed}">
			<div class="bg"></div>
			<a href="#" class="button" data-bind="click: pressPlay">
				<span class="fa fa-fw fa-play" style="font-size: 1.5rem"></span>
			</a>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="static/jquery-ui-sortable/jquery-ui.js"></script>
<script src="static/knockout-sortable.min.js"></script>
<script>
var emotions_data = {{ emotions|tojson|safe }};
var sounds_data = {{ sounds|tojson|safe }};

var scriptname = null;
var isScriptModified = false;
</script>
<script>
$(document).ready(function(){
	$("#btnShutdown").click(function(){
		$("#ShutdownModal .content").load("/shutdown");
	});

	function addError(msg){
		$("#errors").append("<div data-alert class=\"alert-box alert\">" + msg + "<a href=\"#\" class=\"close\">&times;</a></div>");
		$(document).foundation("alert", "reflow");
	}

	function addMessage(msg){
		$("#errors").append("<div data-alert class=\"alert-box success\">" + msg + "<a href=\"#\" class=\"close\">&times;</a></div>");
		$(document).foundation("alert", "reflow");
	}

	$.ajax({
		dataType: "json",
		url: "servos/enable",
		success: function(data){
			if(data.status == "error"){
				addError(data.message);
			}
		}
	});

	ko.bindingHandlers.avatar = {
		update: function(element, valueAccessor, allBindings) {
			var value = valueAccessor();
			var valueUnwrapped = ko.unwrap(value);
			$(element).css("background", "url('static/avatars/" + valueUnwrapped + "')")
		}
	};

	ko.bindingHandlers.outputswitch = {
		init: function(element, valueAccessor){
			$(element).change(function(){
				var value = valueAccessor();
				if( $(element).prop("checked") ){
					value("wav");
				}else{
					value("tts");
				}
			});
		},
		update: function(element, valueAccessor, allBindings) {
			var value = valueAccessor();
			var valueUnwrapped = ko.unwrap(value);
			$(element).prop("checked", valueUnwrapped == "tts" ? false : true);
		}
	};

	var switchID = 0; // Variable to generate unique IDs for toggle switches

	// Here's my data model
	var VoiceLine = function(emotion, output, tts, wav){
		var self = this;

		self.emotion = ko.observable(emotion || emotions_data[0]);

		self.output = ko.observable(output || "tts");
		self.tts = ko.observable(tts || "");
		self.wav = ko.observable(wav || sounds_data[0]);

		self.isPlaying = ko.observable(false);
		self.hasPlayed = ko.observable(false);

		self.switchID = "output-switch-" + switchID++;

		self.contentPreview = ko.pureComputed(function(){
			if(self.output() == "tts"){
				// Generate tts preview html
				return "<span class='fa fa-comment'></span> " + self.tts();
			}else{
				// Generate wav preview html
				return "<span class='fa fa-music'></span> " + self.wav();
			}
		});

		self.avatar = ko.pureComputed(function(){
			return self.emotion().image;
		});

		self.toggleOutput = function(){
			if(this.output() == "tts"){
				this.output("wav");
			}else{
				this.output("tts");
			}
		};

		self.pressPlay = function(){
			// if(self.isPlaying()){
			// 	self.isPlaying(false);
			// 	self.hasPlayed(true);
			// }else{
			$.ajax({
				dataType: "json",
				data: {"phi": self.emotion().phi, "r": self.emotion().r},
				type: "POST",
				url: "setemotion",
				success: function(data){
					if(data.status == "error"){
						addError(data.message);
					}
				}
			});
			if(this.output() == "tts"){
				$.ajax({
					dataType: "json",
					type: "GET",
					url: "saytts",
					data: {text: self.tts()}
				});
			}else{
				$.ajax({
					dataType: "json",
					type: "GET",
					url: "play/" + self.wav(),
					success: function(data){
						if(data.status == "error"){
							addError(data.message);
						}
					}
				});
			}
			self.isPlaying(true)
			// }
		};

		self.pickEmotion = function(){
			if(model.fileLocked()){
				return;
			}

			model.selectedVoiceLine(self);
			$("#PickEmotionModal").foundation("reveal", "open");
		};
	}

	var SocialScriptModel = function(){
		var self = this;

		self.fileLocked = ko.observable(false);
		self.fileIsModified = ko.observable(false);
		self.fileName = ko.observable("Untitled");

		self.sounds = sounds_data;
		self.emotions = emotions_data;

		self.selectedVoiceLine = ko.observable();

		self.voiceLines = ko.observableArray();
		self.init = function(){
			self.voiceLines.removeAll();
			self.voiceLines.push(new VoiceLine(self.emotions[0], "tts", "Hello", ""));
			self.voiceLines.push(new VoiceLine(self.emotions[1], "wav", "Oooh.wav", ""));
			self.voiceLines.push(new VoiceLine(self.emotions[2], "tts", "Ouch!", ""));
		};
		self.init();

		self.toggleLocked = function(){
			self.fileLocked( !self.fileLocked() );
		};

		self.addLine = function(){
			self.voiceLines.push( new VoiceLine(self.emotions[0], "tts", "", "") );
		};

		self.removeLine = function(line){
			self.voiceLines.remove(line);
		};

		self.showFiles = function(){
			$("#FilesModalSpinner").removeClass("hide");
			$("#FilesModalFilelist").html("");
			$("#FilesModalFilelist").load("filelist", function(){
				$("#FilesModalSpinner").addClass("hide");

				// Delete and Open button events need to be rebound here
				// because filelist is loaded via AJAX
				$(".btnDeleteFile").off("click");
				$(".btnDeleteFile").on("click", function(){
					filename = $(this).closest("div.file").data("scriptfile");
					$("#ConfirmDeleteModal").foundation("reveal", "open");
				});

				$(".btnOpenFile").off("click");
				$(".btnOpenFile").on("click", function(){
					filename = $(this).closest("div.file").data("scriptfile");

					var do_load = function(){
						$.ajax({
							url: "scripts/" + filename,
							dataType: "text",
							cache: false,
							success: function(data){
								// Load script
								self.voiceLines.removeAll();

								var dataobj = JSON.parse(data);
								//alert(dataobj.voice_lines[0].output.data);
								$.each(dataobj.voice_lines, function(idx, line){
									var emo = self.emotions[0];
									$.each(self.emotions, function(idx, emot){
										if(emot.name == line.emotion){
											emo = emot;
										}
									});

									if(line.output.type == "tts"){
										self.voiceLines.push(new VoiceLine(emo, line.output.type, line.output.data, ""));
									}else{
										self.voiceLines.push(new VoiceLine(emo, line.output.type, "", line.output.data));
									}
								});

								// Update filename and asterisk
								var filename_no_ext = filename;
								if(filename_no_ext.slice(-4) == ".soc" || filename_no_ext.slice(-4) == ".SOC"){
									filename_no_ext = filename_no_ext.slice(0, -4);
								}
								$(".filebox .filename").text(filename_no_ext);
								$(".filebox .fa-asterisk").addClass("hide");
								isScriptModified = false;
								scriptname = filename;

								$("#FilesModal").foundation("reveal", "close");
							}
						});
					}

					if(isScriptModified){
						$("#btnConfirmLoad").off("click");
						$("#btnConfirmLoad").on("click", do_load);
						$("#ConfirmLoadModal").foundation("reveal", "open");
					}else{
						do_load();
					}

				});
			});

			$("#FilesModal").foundation("reveal", "open");
		};

		self.newFile = function(){
			// if(isScriptModified){
			$("#ConfirmNewModal").foundation("reveal", "open");
			// }else{
			// 	self.createNewFile();
			// }
		};

		self.createNewFile = function(){
			// if(scriptname != null){
				scriptname = null;

				self.init();

				$(".filebox .filename").html("Untitled");
				$(".filebox .fa-asterisk").addClass("hide");

				$("#ConfirmNewModal").foundation("reveal", "close");
			// }
		};

		self.deleteFile = function(){
			$.ajax({
				dataType: "json",
				type: "POST",
				url: "delete/" + filename,
				success: function(data){
					$("#ConfirmDeleteModal").foundation("reveal", "close");
					if(data.status == "error"){
						addError(data.message);
					}else{
						addMessage(data.message);
					}
				}
			});
		};

		self.askSaveFile = function(){
			if(scriptname == null){
				// Untitled script
				$("#txtFilename").val("");
				$("#SaveAsModal small.error").addClass("hide");
				$("#SaveAsModal").foundation("reveal", "open");
			}else{
				var file_data = {voice_lines: []};
				$.each(self.voiceLines(), function(idx, item){
					var line = {};
					line.emotion = item.emotion().name;
					line.output = {};

					if(item.output() == "tts"){
						line.output.type = "tts";
						line.output.data = item.tts();
					}else if(item.output() == "wav"){
						line.output.type = "wav";
						line.output.data = item.wav();
					}else{
						line.output.type = "tts";
						line.output.data = "";
					}

					file_data.voice_lines.push(line);
				});
				//console.log(file_data);
				var json_data = ko.toJSON(file_data, null, 2);

				$.ajax({
					dataType: "json",
					data: {
						file: json_data,
						filename: scriptname,
						overwrite: 1
					},
					type: "POST",
					url: "save",
					success: function(data){
						if(data.status == "error"){
							addError(data.message);
						}else if(data.status == "success"){
							scriptname = data.filename;
							isScriptModified = false;

							var filename_no_ext = data.filename;
							if(filename_no_ext.slice(-4) == ".soc" || filename_no_ext.slice(-4) == ".SOC"){
								filename_no_ext = filename_no_ext.slice(0, -4);
							}

							$(".filebox .fa-asterisk").addClass("hide");
							$(".filebox .filename").html(filename_no_ext);
						}
					}
				});
				//alert(json_data);
			}
		};

		self.saveFile = function(){
			var filename = $("#txtFilename").val();

			$("#SaveAsModal small.error").addClass("hide");

			var file_data = {voice_lines: []};
			$.each(self.voiceLines(), function(idx, item){
				var line = {};
				line.emotion = item.emotion().name;
				line.output = {};

				if(item.output() == "tts"){
					line.output.type = "tts";
					line.output.data = item.tts();
				}else if(item.output() == "wav"){
					line.output.type = "wav";
					line.output.data = item.wav();
				}else{
					line.output.type = "tts";
					line.output.data = "";
				}

				file_data.voice_lines.push(line);
			});
			//console.log(file_data);
			var json_data = ko.toJSON(file_data, null, 2);

			$.ajax({
				dataType: "json",
				data: {
					file: json_data,
					filename: filename,
					overwrite: 0
				},
				type: "POST",
				url: "save",
				success: function(data){
					if(data.status == "error"){
						$("#SaveAsModal small.error").html(data.message).removeClass("hide");
					}else if(data.status == "success"){
						scriptname = data.filename;
						isScriptModified = false;

						var filename_no_ext = data.filename;
						if(filename_no_ext.slice(-4) == ".soc" || filename_no_ext.slice(-4) == ".SOC"){
							filename_no_ext = filename_no_ext.slice(0, -4);
						}

						$(".filebox .fa-asterisk").addClass("hide");
						$(".filebox .filename").html(filename_no_ext);

						$("#SaveAsModal").foundation("reveal", "close");
					}
				}
			});
			return 0;
		};

		self.changeEmotion = function(emotion){
			self.selectedVoiceLine().emotion(emotion);
			$("#PickEmotionModal").foundation("reveal", "close");
		};
	};
	// This makes Knockout get to work
	var model = new SocialScriptModel();
	ko.applyBindings(model);
});
</script>
{% endblock %}

{% block modals %}
{{ super() }}
<div id="PickEmotionModal" class="reveal-modal tiny" data-reveal>
	<div class="content">
		<ul class="small-block-grid-4" data-bind="foreach: emotions">
			<li>
				<div class="avatar" data-bind="click: $root.changeEmotion"><div data-bind="avatar: image"></div></div>
				<div class="avatarcaption" data-bind="text: name"></div>
			</li>
		</ul>
	</div>
</div>

<div id="SaveAsModal" class="reveal-modal tiny" data-reveal>
	<div class="titlebar">
		<a class="close-reveal-modal"><span class="fa fa-close"></span></a>
		<span class="fa fa-save"></span> Save as
	</div>
	<div class="content">
		<p>Please enter a name for this script.</p>
		<form>
			<div class="row collapse">
				<div class="small-9 columns">
					<input type="text" name="txtFilename" id="txtFilename" class="error" style="width: 100%;">
					<small class="error hide"></small>
				</div>
				<div class="small-3 columns">
					<a href="#" class="button" style="width: 100%;" data-bind="click: saveFile"><span class="fa fa-save"></span> Save</a>
				</div>
			</div>
		</form>
	</div>
</div>

<div id="FilesModal" class="reveal-modal small" data-reveal>
	<div class="titlebar">
		<a class="close-reveal-modal"><span class="fa fa-close"></span></a>
		<span class="fa fa-folder"></span> All files
	</div>
	<div class="content">
		<div id="FilesModalSpinner" style="text-align: center;">
			<span class="fa fa-circle-o-notch fa-spin fa-2x"></span>
		</div>
		<div id="FilesModalFilelist"></div>
	</div>
</div>

<div id="ConfirmNewModal" class="reveal-modal tiny" data-reveal>
	<div class="titlebar">
		<a class="close-reveal-modal"><span class="fa fa-close"></span></a>
		<span class="fa fa-file"></span> New
	</div>
	<div class="content">
		<p>Changes could be lost. Are you sure you wish to continue without saving?</p>
		<div class="text-center">
			<a href="#" class="button" data-bind="click: createNewFile"><span class="fa fa-file"></span> Yes, discard changes</a>
		</div>
	</div>
</div>

<div id="ConfirmDeleteModal" class="reveal-modal tiny" data-reveal>
	<div class="titlebar">
		<a class="close-reveal-modal"><span class="fa fa-close"></span></a>
		<span class="fa fa-trash"></span> Delete
	</div>
	<div class="content">
		<p>Are you sure you wish to delete this file?</p>
		<div class="text-center">
			<a href="#" class="button" data-bind="click: deleteFile"><span class="fa fa-trash"></span> Yes, delete file</a>
		</div>
	</div>
</div>

<div id="ConfirmLoadModal" class="reveal-modal tiny" data-reveal>
	<div class="titlebar">
		<a class="close-reveal-modal"><span class="fa fa-close"></span></a>
		<span class="fa fa-folder-open"></span> Load
	</div>
	<div class="content">
		<p>Unsaved changes will be lost. Are you sure you wish to continue?</p>
		<div class="text-center">
			<a href="#" id="btnConfirmLoad" class="button"><span class="fa fa-folder-open"></span> Yes, load file</a>
		</div>
	</div>
</div>
{% endblock %}
